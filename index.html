<!doctype html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Light, Woods" />





  <link rel="alternate" href="/atom.xml" title="林中小灯" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="个人技术博客分享">
<meta property="og:type" content="website">
<meta property="og:title" content="林中小灯">
<meta property="og:url" content="http://lightthewoods.me/index.html">
<meta property="og:site_name" content="林中小灯">
<meta property="og:description" content="个人技术博客分享">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="林中小灯">
<meta name="twitter:description" content="个人技术博客分享">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"right","display":"always","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://lightthewoods.me/"/>





  <title> 林中小灯 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-97204025-1', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?33c8066a182d569550ea355708fe9061";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>







  <div style="display: none;">
    <script src="//s95.cnzz.com/z_stat.php?id=1261711358&web_id=1261711358" language="JavaScript"></script>
  </div>






  
  
    
  

  <div class="container sidebar-position-right 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">林中小灯</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Light the woods</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://lightthewoods.me/2017/04/18/From-Linux-FS-to-Hadoop-hdfs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ethan Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xpwqp.com1.z0.glb.clouddn.com/avatar_01.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="林中小灯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/18/From-Linux-FS-to-Hadoop-hdfs/" itemprop="url">
                  从Linux文件系统到Hadoo分布式文件系统hdfs
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-18T20:02:16+08:00">
                2017-04-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>做大数据的同学是绕不开Hadoop生态圈的，可能每天使用最多的就是hadoop上的分布式文件系统hdfs了。那么，为什么hdfs会称为一种“文件系统”呢？仅仅是因为他的命令与服务器上的Linux操作系统的各类文件系统命令类似或相同吗？那么hdfs又与Linux上的文件系统FS有什么异同吗？下面我们就来聊一聊这些问题。<br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/04/18/From-Linux-FS-to-Hadoop-hdfs/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://lightthewoods.me/2017/04/10/教你手写红黑树羞辱面试官/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ethan Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xpwqp.com1.z0.glb.clouddn.com/avatar_01.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="林中小灯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/04/10/教你手写红黑树羞辱面试官/" itemprop="url">
                  教你手写红黑树羞辱面试官
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-04-10T18:34:15+08:00">
                2017-04-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>之前在网上看过一个搞笑的关于面试的段子，说的是两个妹子A和B去某司面试前端开发岗位。<br>A妹子又黑又矮，面试官说“写个二叉树查找”，瞬间写完，面试官又说“写个快速排序”，又秒写，”再写个红黑树的插入”，A妹子挠挠头，走了。<br>B妹子生的明艳动人，面试官说“额，写个Hello World吧”，B妹子说，“我不会”，面试官喜笑颜开“没事没事，我来教你”。<br>这个段子折射出一个问题，那就是在面试过程中手写红黑树很难，几乎是一个不可能完成的任务，所以网上才会有很多手写红黑树的段子。</p>
<p>那么数据结构与算法中的红黑树真的很难吗？手写红黑树真的是Mission Impossible吗？其实红黑树并没有很难，算是数据结构中比较初级的算法，不能完整的将这个算法手写或者说手推下来（并不提倡默写），证明对算法的整个流程并没有完全的掌握，对算法的原理和意义一知半解，不是十分清晰。</p>
<p>下面，将教你一步步掌握红黑树，万一我们长得不是那么“明艳动人”，也能凭借实例吊打面试官~<br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2017/04/10/教你手写红黑树羞辱面试官/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://lightthewoods.me/2016/05/23/终端命令行操作系统剪切板/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ethan Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xpwqp.com1.z0.glb.clouddn.com/avatar_01.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="林中小灯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/05/23/终端命令行操作系统剪切板/" itemprop="url">
                  使用终端命令行控制剪贴板
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-05-23T19:00:02+08:00">
                2016-05-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>复制和粘贴的功能可能是我们平时使用电脑时用到最多的功能，操作系统为了实现复制粘贴功能实际上在后台提供了一个剪贴板的功能，剪贴板是一个中转，方便我们在不同的软件程序之间拷贝字符。除了常用的ctrl-c和ctrl-v大法（大笑），你还知道其他的使用方式吗？<br>比如在工作中，有一个程序出现了某些错误输出，我们需要把这些东西拷贝到QQ等通选软件上以便和其他人沟通，需要经过以下几个步骤：</p>
<ol>
<li>把结果输出到一个文件</li>
<li>用编辑器打开这个文件</li>
<li>鼠标选中要复制的内容</li>
<li>ctrl-c复制</li>
<li>打开QQ等通讯软件</li>
<li>ctrl-v粘贴</li>
</ol>
<p>可以看到一个小小的操作需要这么多步骤，而且需要在不同的窗口间频繁的切换，如果要复制的内容比较多，非常容易出错。而且，各种文本编辑器，为了达到所见即所得的效果，它的编辑区里面是有格式化字符的，比如制表符，换行、回车等。所以我们选中想拷贝的段落，是会连带编辑区中的字符一起拷贝过去的，这些隐藏的格式字符到了另外一个程序里面也许就会产生各种问题。我自己之前就曾经遇到过类似的问题，用过github的同学可能知道，github的权限管理是基于RSA公私钥体系的，这就需要我们把自己生成的公钥复制粘贴到浏览器上点击提交后再上传到github的服务器上，以便为后续的操作提供权限验证。我当时不论是打开编辑器后拷贝字符还是用cat将文件输出到console里面再复制粘贴过去，都不能成功，后来才知道是带了一些隐藏的格式化控制字符。<br>其实，剪贴板作为操作系统提供的一个功能，不管是windows、linux还是mac系统，除了GUI常见的鼠标加键盘复制粘贴的方法之后，肯定都会提供命令行操作的接口。如果你的工作中经常会用到命令行的工具，经常需要直接把命令的输出（比如grep/awk/sed/find或是你的程序输出结果）放到剪切板上，以便方便拷贝到QQ等IM软件上，那么下面的方法非常适合你。<br>好了，说了这么多终于要介绍使用方法了：</p>
<h3 id="Mac"><a href="#Mac" class="headerlink" title="Mac"></a>Mac</h3><p>拷贝至剪贴板使用<code>pbcopy</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">pbcopy &lt; file.txt</div><div class="line">#还支持管道的方式输出</div><div class="line">echo &apos;Hello clip&apos; | pbcopy</div></pre></td></tr></table></figure></p>
<p>对应的粘贴使用<code>pbpaste</code>命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pbpaste &gt; file.txt</div><div class="line">pbpaste | grep &apos;Hello&apos;</div></pre></td></tr></table></figure></p>
<h3 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h3><p>许多网站可能可能比较倾向于使用xclip<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo &apos;Hello clip&apos; | xclip</div></pre></td></tr></table></figure></p>
<p>如果想粘贴到图形界面程序可能还要加参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo &apos;Hello clip&apos; | xclip -selection clipboard</div></pre></td></tr></table></figure></p>
<p>我觉得用这个很不方便，要区分linux里面几种剪贴板的类型。而且我使用过程中经常出现粘贴失败的问题，好在后来我找到了替代的工具<code>xsel</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">echo &apos;Hello clip&apos; | xsel</div><div class="line">xsel &lt; file.txt</div><div class="line">#清空剪切板</div><div class="line">xsel -c</div></pre></td></tr></table></figure></p>
<h3 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h3><p>windws下的剪贴板工具命令为clip，简单好记<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">#将字符串Hello放入windows剪贴板</div><div class="line">echo Hello | clip</div><div class="line"></div><div class="line">#将dir命令的输出放入windows剪贴板</div><div class="line">dir | clip</div><div class="line"></div><div class="line">#将file.txt文件的文本放入windows剪贴板</div><div class="line">clip &lt; file.txt</div><div class="line"></div><div class="line">#将windows剪贴板中的内容写入file.txt文件</div><div class="line">clip &gt; file.txt</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://lightthewoods.me/2016/02/24/函数可变参数的用法及原理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ethan Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xpwqp.com1.z0.glb.clouddn.com/avatar_01.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="林中小灯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/02/24/函数可变参数的用法及原理/" itemprop="url">
                  函数可变参数的用法及原理
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-02-24T10:05:54+08:00">
                2016-02-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h2 id="声明和定义"><a href="#声明和定义" class="headerlink" title="声明和定义"></a>声明和定义</h2><p>C语言中，经常会遇到带有可变参数的函数。对于可变参数函数的声明，只需要用『…』表示不定参数部分即可，如下面的<code>func1</code>。从错误示例<code>func2</code>和<code>func3</code>可以看出，带可变参数的函数必须至少提供一个固定参数。后面的可变参数函数的实现原理可以知道，这个参数将用来对后面的可变参数进行寻址，以便实现对所有可变参数的访问。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">func1</span><span class="params">(<span class="keyword">int</span> a, ...)</span></span>;  <span class="comment">//correct</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">func2</span><span class="params">(...)</span></span>;         <span class="comment">//wrong</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">func3</span><span class="params">(..., <span class="keyword">int</span> a)</span></span>;  <span class="comment">//wrong</span></div></pre></td></tr></table></figure>
<h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h2><p>为了理解带可变参数函数的实现机制，我们需要回顾下函数调用的内存模型。<br>当调用一个函数时，将触发如下动作：</p>
<ol>
<li>开辟该函数的栈空间。</li>
<li>将当前的运行状态压栈。</li>
<li>将函数返回地址压栈。</li>
<li>在栈内为参数分配空间。</li>
<li>在栈内为局部变量分配空间。</li>
<li>执行该函数。</li>
</ol>
<p>以常见的printf函数为例<code>printf(&quot;%d and %c&quot;，a, b)</code>。这里a是int型，不是char型，加上第一个格式化参数，本次printf()调用传递了三个参数。考虑到需要实现可变参数的机制，C语言进行参数压栈的时候，压栈的顺序是从右向左，即先将b入栈，再将a入栈，最后是format入栈。由于栈是向下（低地址）生长的，所以在知道了第一个参数format的地址之后，所有的参数地址都可以计算出来。函数调用内存模型如下图：<br><img src="http://7xpwqp.com1.z0.glb.clouddn.com/2016-02-24-01.jpg" alt="函数调用内存模型"></p>
<h2 id="可变参数的标准宏"><a href="#可变参数的标准宏" class="headerlink" title="可变参数的标准宏"></a>可变参数的标准宏</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//可变参数标准宏头文件</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdarg.h"</span></span></div><div class="line"></div><div class="line"><span class="comment">//申明va_list数据类型变量pvar，该变量访问变长参数列表中的参数。</span></div><div class="line">va_list pvar;</div><div class="line"></div><div class="line"><span class="comment">//宏va_start初始化变长参数列表。pvar是va_list型变量，记载列表中的参数信息。</span></div><div class="line"><span class="comment">//parmN是省略号"..."前的一个参数名，va_start根据此参数，判断参数列表的起始位置。</span></div><div class="line">va_start(pvar, parmN);</div><div class="line"></div><div class="line"><span class="comment">//获取变长参数列表中参数的值。pvar是va_list型变量，type为参数值的类型，也是宏va_arg返回数值的类型。</span></div><div class="line"><span class="comment">//宏va_arg执行完毕后自动更改对象pvar，将其指向下一个参数。</span></div><div class="line">va_arg(pvar, type);</div><div class="line"></div><div class="line"><span class="comment">//关闭本次对变长参数列表的访问。</span></div><div class="line">va_end(pvar);</div></pre></td></tr></table></figure>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2016/02/24/函数可变参数的用法及原理/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://lightthewoods.me/2016/01/07/Change-to-GitPage/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ethan Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xpwqp.com1.z0.glb.clouddn.com/avatar_01.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="林中小灯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/01/07/Change-to-GitPage/" itemprop="url">
                  博客搬新家啦
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-01-07T19:12:32+08:00">
                2016-01-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>&emsp;&emsp;博客搬了新家之后终于又和大家见面了。时逝如隙，从写第一篇博文算起来已经有9年了，说来也是惭愧，直至现在才有了自己的独立博客。其名为林中小灯，同时申请了域名——lightthewoods，意为照亮幽幽森林中的那盏独自闪烁着熠熠光亮的小灯。其实呢，说来说去，还是和我笔名的意义有些关联。虽然我写的东西，分享的内容，在这个时代浩瀚的信息量之中的作用微乎其微，但是我一直会在那里，默默的坚持着。</p>
<p><img src="http://7xpwqp.com1.z0.glb.clouddn.com/2016-01-07-01" alt="lightthewoods"><br>&emsp;&emsp;从MySpace、新浪博客、51、一直到CSDN，用过的博客平台很多很多。看着这些博客平台起步、繁荣、火爆再到一点儿一点儿没落，也一直忍受着各类博客平台上写博的诸多不爽。这么多年来一直没放到独立博客上其实也有很多这样那样的原因。大学的那个年代，搞独立博客，感觉真的像是黑客或者技术大牛才能搞定的东西。虽然自己也是CS专业，充其量也就会用C写个if、else，倒腾倒腾死记硬背下算法书上的各种题目，以求个门专业课不要挂掉。当时世界上最好的语言PHP也才刚刚展露头角，Nginx在那时看来还是黑客大神们搞得替代apache的玩具，用MySQL的人还不如SQL Server的人数的一个零头。更别说那个年代昂贵的VPS的租用价格了。<br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2016/01/07/Change-to-GitPage/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://lightthewoods.me/2015/10/16/《Tornado异步框架及协程相关》讲义/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ethan Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xpwqp.com1.z0.glb.clouddn.com/avatar_01.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="林中小灯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/10/16/《Tornado异步框架及协程相关》讲义/" itemprop="url">
                  《Tornado异步框架及协程相关》讲义
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-10-16T08:04:59+08:00">
                2015-10-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <blockquote>
<p>本文是我在公司做的某次培训活动的一个讲义，放到博客里供大家参考</p>
</blockquote>
<p><img src="http://7xpwqp.com1.z0.glb.clouddn.com/Tornado%E5%BC%82%E6%AD%A5%E6%A1%86%E6%9E%B6%E5%8F%8A%E5%8D%8F%E7%A8%8B%E7%9B%B8%E5%85%B3.001.jpeg" alt="ppt1"><br><img src="http://7xpwqp.com1.z0.glb.clouddn.com/Tornado%E5%BC%82%E6%AD%A5%E6%A1%86%E6%9E%B6%E5%8F%8A%E5%8D%8F%E7%A8%8B%E7%9B%B8%E5%85%B3.004.jpeg" alt="ppt4"><br><img src="http://7xpwqp.com1.z0.glb.clouddn.com/Tornado%E5%BC%82%E6%AD%A5%E6%A1%86%E6%9E%B6%E5%8F%8A%E5%8D%8F%E7%A8%8B%E7%9B%B8%E5%85%B3.005.jpeg" alt="ppt5"><br><img src="http://7xpwqp.com1.z0.glb.clouddn.com/Tornado%E5%BC%82%E6%AD%A5%E6%A1%86%E6%9E%B6%E5%8F%8A%E5%8D%8F%E7%A8%8B%E7%9B%B8%E5%85%B3.006.jpeg" alt="ppt6"><br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2015/10/16/《Tornado异步框架及协程相关》讲义/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://lightthewoods.me/2015/04/20/当黑客马拉松遇上全栈工程师/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ethan Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xpwqp.com1.z0.glb.clouddn.com/avatar_01.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="林中小灯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/04/20/当黑客马拉松遇上全栈工程师/" itemprop="url">
                  当黑客马拉松遇上全栈工程师
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-04-20T14:05:22+08:00">
                2015-04-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>&emsp;&emsp;4月17号参加了新浪微博平台架构组织的HackAthon24小时黑客马拉松活动。想想还是第一次参加这一类的技术活动，心情上感觉新奇又激情。其实感觉后端工程师在这种创新类比赛上优势不明显，幸遇@赵青-Q不嫌弃，热情的接纳了我，终于有机会得以参赛。</p>
<p><img src="http://7xpwqp.com1.z0.glb.clouddn.com/2014%2F04%2F20-01" alt="all member"></p>
<p>&emsp;&emsp;曾经听前辈们闲聊的时候提到过，黑客马拉松应该是起源于FaceBook的一些小活动。每到了周五的下午，开发任务不忙的工程师们会聚在一起，先喝一点啤酒，吃一点小零食，把自己搞high一些，然后大家开始头脑风暴，畅所欲言，吐槽别人的代码，吐槽公司某些项目的架构，并可以随意向其他人的代码或者架构提出挑战，拿出自己认为合适的方案甚至是实现，展现出一种异常开放的技术氛围。必定的，这种routine，这种开放的讨论激烈的碰撞对于提升公司项目的架构及代码质量以及对于工程师自身水平的提高都是非常有帮助的。后来，慢慢的演变成为一种活动，在规定的24小时内，工程师们组队完成一个独立的项目，可以是和公司的业务完全没有关系的，纯粹只是为了实现自己心中的想象力。这个活动将工程师从日常繁重的开发任务中解放出来，应用一些日常工作中用不到的技术，实现一些好玩有趣的事情。<br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2015/04/20/当黑客马拉松遇上全栈工程师/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://lightthewoods.me/2015/01/06/多线程C调用python-api的陷阱/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ethan Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xpwqp.com1.z0.glb.clouddn.com/avatar_01.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="林中小灯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/01/06/多线程C调用python-api的陷阱/" itemprop="url">
                  多线程C调用python api的陷阱
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-01-06T11:45:22+08:00">
                2015-01-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>　　众所周知，用脚本语言编写的服务（wsgi接口）都需要一个server容器，常见的如php的php-fpm, lightd等。python中一般是用的uwsgi，uwsgi是在wsgi的基础上的一种新的协议，可以用来部署python等脚本程序的运行。然而在不熟悉uwsgi的代码架构和c调用python的api情况下进行开发可能会遇到一些意想不到的问题。<br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2015/01/06/多线程C调用python-api的陷阱/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://lightthewoods.me/2014/07/26/谈谈如何设计秒杀服务/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ethan Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xpwqp.com1.z0.glb.clouddn.com/avatar_01.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="林中小灯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/07/26/谈谈如何设计秒杀服务/" itemprop="url">
                  谈谈如何设计秒杀服务
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-07-26T12:34:10+08:00">
                2014-07-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>　　上周末去百度参加了一场LBS部门的招聘专场，虽然刚换了工作，但是人力资源美眉盛情邀请，而且是周末也不用请假，本着去学习的心态去试了一下。以前去百度面试过几次，面试官给人的感觉还是很nice的，虽然不会像很多外企的面试官会闲到给你讲课，但是会和你一起讨论面试的问题，共同的提高。<br>　　百度招聘，区别于360等新兴创业型公司，更偏重于工程师的设计技能和思维方法。百度招聘不会深入的考察工程师所用语言的特性，陷阱等问题，而更关注考察基本的数据结构算法及其在实际例子中的应用。<br>　　一面还是偏向考察基本数据结构的掌握的，问了一些诸如跳跃表的实现，快速排序和堆排序，并发程序的数据同步问题等，现场写了一个单向链表递归反转的函数。<br>　　二面就是偏向考察思维方法了，因为知道我是新浪过来的，问了一个怎样设计一个大V粉丝TOP10排名的服务。另外一个印象比较深的问题就是如何实现秒杀的服务。<br>　　这里主要想和大家聊聊秒杀服务的实现方法。<br>　　秒杀服务在日常的互联网生活中非常常见，广告心理学曾近分析过，人们对于免费、低价等字眼的抵抗力往往非常低，所以秒杀是一种成本低廉又行之有效的营销方式。<br>　　当然，从技术上来讲，秒杀对于后端服务同时也是一场噩梦。试想，如果前期宣传工作做得完备，数百万的用户守护在各种终端旁，在同一时刻进行请求，这个流量的峰值将会多么的可怕。<br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2014/07/26/谈谈如何设计秒杀服务/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://lightthewoods.me/2014/07/14/memcached几个容易被忽略但非常有用的命令/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ethan Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xpwqp.com1.z0.glb.clouddn.com/avatar_01.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="林中小灯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/07/14/memcached几个容易被忽略但非常有用的命令/" itemprop="url">
                  memcached几个容易被忽略但非常有用的命令
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-07-14T11:25:29+08:00">
                2014-07-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <h1 id="一、CAS和GETS"><a href="#一、CAS和GETS" class="headerlink" title="一、CAS和GETS"></a>一、CAS和GETS</h1><p>　　Memcached从1.2.4版本新增CAS(Check and Set)协议，用于处理同一个ITEM（key-value）被多个session更新修改时的数据一致性问题。<br>　　假设有两个session（A、B），要同时修改某个key的值x，并且修改的数据是基于原来数据的一个计算的结果。session A和B同时得到了key的值x，session A经过计算后应该更新为y，session B经过计算后也更新为y，但是session B其实期望的是拿到y值，并将其计算为Z后更新。造成这个问题的原因就是缺少一个类似于MySQL的事务，用于数据并发修改的一致性问题。<br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2014/07/14/memcached几个容易被忽略但非常有用的命令/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://lightthewoods.me/2014/02/17/黑科技-巧用二级指针删除单向链表/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ethan Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xpwqp.com1.z0.glb.clouddn.com/avatar_01.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="林中小灯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2014/02/17/黑科技-巧用二级指针删除单向链表/" itemprop="url">
                  黑科技--巧用二级指针删除单向链表
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2014-02-17T16:43:16+08:00">
                2014-02-17
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>　　Linus大婶在<a href="http://meta.slashdot.org/story/12/10/11/0030249/linus-torvalds-answers-your-questions">slashdot</a>上回答一些编程爱好者的提问，其中一个人问他什么样的代码是他所喜好的，大婶表述了自己一些观点之后，举了一个指针的例子，解释了什么才是<strong>core low-level coding</strong>。<br>　　下面是Linus的教学原文及翻译</p>
<blockquote>
<p>“At the opposite end of the spectrum, I actually wish more people understood the really core low-level kind of coding. Not big, complex stuff like the lockless name lookup, but simply good use of pointers-to-pointers etc. For example, I’ve seen too many people who delete a singly-linked list entry by keeping track of the “prev” entry, and then to delete the entry, doing something like。（在这段话的最后，我实际上希望更多的人了解什么是真正的核心底层代码。这并不像无锁文件名查询（注：可能是git源码里的设计）那样庞大、复杂，只是仅仅像诸如使用二级指针那样简单的技术。例如，我见过很多人在删除一个单项链表的时候，维护了一个”prev”表项指针，然后删除当前表项，就像这样）”<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (prev)</div><div class="line">    prev-&gt;next = entry-&gt;next;</div><div class="line"><span class="keyword">else</span></div><div class="line">    list_head = entry-&gt;next;</div></pre></td></tr></table></figure></p>
<p>and whenever I see code like that, I just go “This person doesn’t understand pointers”. And it’s sadly quite common.（当我看到这样的代码时，我就会想“这个人不了解指针”。令人难过的是这太常见了。）<br>People who understand pointers just use a “pointer to the entry pointer”, and initialize that with the address of the list_head. And then as they traverse the list, they can remove the entry without using any conditionals, by just doing a “<code>*pp = entry-&gt;next</code>”. （了解指针的人会使用链表头的地址来初始化一个“指向节点指针的指针”。当遍历链表的时候，可以不用任何条件判断（注：指prev是否为链表头）就能移除某个节点，只要写“<code>*pp = entry-&gt;next</code>”)<br>So there’s lots of pride in doing the small details right. It may not be big and important code, but I do like seeing code where people really thought about the details, and clearly also were thinking about the compiler being able to generate efficient code (rather than hoping that the compiler is so smart that it can make efficient code <em>despite</em> the state of the original source code). （纠正细节是令人自豪的事。也许这段代码并非庞大和重要，<strong>但我喜欢看那些注重代码细节的人写的代码，也就是清楚地了解如何才能编译出有效代码</strong>（而不是寄望于聪明的编译器来产生有效代码，即使是那些原始的汇编代码））。</p>
</blockquote>
<p>　　Linus举了一个单向链表的例子，但给出的代码太短了，一般的人很难搞明白这两个代码后面的含义。正好，有个编程爱好者阅读了这段话，并给出了一个<a href="http://wordaligned.org/articles/two-star-programming">比较完整的代码</a>。他的话我就不翻译了，下面给出代码说明。<br>　　如果我们需要写一个<code>remove_if(link*, rm_cond_func*)</code>的函数，也就是传入一个单向链表，和一个自定义的是否删除的函数，然后返回处理后的链接。<br>　　这个代码不难，基本上所有的教科书都会提供下面的代码示例，而这种写法也是大公司的面试题标准模板：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> node</div><div class="line">&#123;</div><div class="line">    <span class="keyword">struct</span> node * next;</div><div class="line">    ....</div><div class="line">&#125; node;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">bool</span> <span class="params">(* remove_fn)</span><span class="params">(node <span class="keyword">const</span> * v)</span></span>;</div><div class="line"></div><div class="line"><span class="comment">// Remove all nodes from the supplied list for which the</span></div><div class="line"><span class="comment">// supplied remove function returns true.</span></div><div class="line"><span class="comment">// Returns the new head of the list.</span></div><div class="line"><span class="function">node * <span class="title">remove_if</span><span class="params">(node * head, remove_fn rm)</span></div><div class="line"></span>&#123;</div><div class="line">    <span class="keyword">for</span> (node * prev = <span class="literal">NULL</span>, * curr = head; curr != <span class="literal">NULL</span>; )</div><div class="line">    &#123;</div><div class="line">        node * <span class="keyword">const</span> next = curr-&gt;next;</div><div class="line">        <span class="keyword">if</span> (rm(curr))</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (prev)</div><div class="line">                prev-&gt;next = next;</div><div class="line">            <span class="keyword">else</span></div><div class="line">                head = next;</div><div class="line">            <span class="built_in">free</span>(curr);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">            prev = curr;</div><div class="line">        curr = next;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> head;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>　　这里remove_fn由调用查提供的一个是否删除当前实体结点的函数指针，其会判断删除条件是否成立。这段代码维护了两个节点指针prev和curr，<strong>标准的教科书写法——删除当前结点时，需要一个previous的指针，并且还要这里还需要做一个边界条件的判断——curr是否为链表头</strong>。于是，要删除一个节点（不是表头），只要将前一个节点的next指向当前节点的next指向的对象，即下一个节点（即：<code>prev-&gt;next = curr-&gt;next</code>），然后释放当前节点。<br>　　但在Linus看来，这是不懂指针的人的做法。那么，什么是core low-level coding呢？那就是<strong>有效地利用二级指针，将其作为管理和操作链表的首要选项</strong>。代码如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">remove_if</span><span class="params">(node ** head, remove_fn rm)</span></div><div class="line"></span>&#123;</div><div class="line">    <span class="keyword">for</span> (node** curr = head; *curr; )</div><div class="line">    &#123;</div><div class="line">        node * entry = *curr;</div><div class="line">        <span class="keyword">if</span> (rm(entry))</div><div class="line">        &#123;</div><div class="line">            *curr = entry-&gt;next;</div><div class="line">            <span class="built_in">free</span>(entry);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span></div><div class="line">            curr = &amp;entry-&gt;next;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2014/02/17/黑科技-巧用二级指针删除单向链表/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://lightthewoods.me/2013/12/23/Tornado用回调代替gen/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ethan Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xpwqp.com1.z0.glb.clouddn.com/avatar_01.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="林中小灯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2013/12/23/Tornado用回调代替gen/" itemprop="url">
                  Tornado用回调代替gen
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2013-12-23T18:01:32+08:00">
                2013-12-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Tornado利用python的yield机制，用gen模块可以用同步的代码逻辑书写异步调用的代码。一般的，在程序开发过程中，方便的书写逻辑必然会带来运行上的额外开销。笔者的一个整合型爬虫服务设计大量的异步调用逻辑，出现HTTP超时的比例大概为1%，查看被调用的服务日志未出现超时，怀疑是gen的协程机制未有能使IOLoop的读事件及时响应（注：此问题还未能验证）。</p>
<p>下面就将常见的两种异步调用场景从Tornado的gen同步逻辑改为普通的callback异步逻辑：</p>
<ol>
<li><p>多次重试异步调用<br>我们访问的外部接口可能由于各种原因需要在发生错误后重试N次，用Tornado的协程来写应该是下面这样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> tornado.web</div><div class="line"><span class="keyword">import</span> tornado.gen</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span>                                                                            </div><div class="line"></div><div class="line"><span class="meta">    @tornado.web.asynchronous</span></div><div class="line"><span class="meta">    @tornado.gen.engine                                                                                                   </span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""Tornado handler post 入口                                                                                      </span></div><div class="line">        """</div><div class="line"></div><div class="line">        <span class="keyword">try</span>:                                                                                                              </div><div class="line">            ...                                                                                                           </div><div class="line">            some biz code here                                                                                            </div><div class="line">            ...                                                                                                           </div><div class="line"></div><div class="line">            retry_n = <span class="number">3</span>                                                                                                   </div><div class="line">            <span class="keyword">while</span> retry_n &gt; <span class="number">0</span>:                                                                                            </div><div class="line">                response = <span class="keyword">yield</span> tornado.gen.Task(http_client.fetch, request)                                             </div><div class="line">                <span class="keyword">if</span> response.code == <span class="number">200</span>:                                                                                  </div><div class="line">                    <span class="keyword">break</span></div><div class="line">                retry_n -= <span class="number">1</span></div><div class="line">            <span class="keyword">else</span>:   </div><div class="line">                <span class="comment">#超过了重试的最大次数，抛出异常                                                                           </span></div><div class="line">                <span class="keyword">raise</span> ServiceError                                                                                        </div><div class="line"></div><div class="line">            ...</div><div class="line">            some biz code here</div><div class="line">            ...</div><div class="line">            self.finish(ok)</div><div class="line"></div><div class="line">        <span class="keyword">except</span>:</div><div class="line">            ....</div></pre></td></tr></table></figure>
<p>改为普通的异步回调callback的写法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> tornado.web</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></div><div class="line"></div><div class="line"><span class="meta">    @tornado.web.asynchronous</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""Tornado handler post 入口</span></div><div class="line">        """</div><div class="line"></div><div class="line">        ...</div><div class="line">        some biz code here</div><div class="line">        ...</div><div class="line"></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            notify(<span class="number">3</span>)</div><div class="line">        <span class="keyword">except</span>:</div><div class="line">            ...</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post1</span><span class="params">(self, data)</span>:</span></div><div class="line">        <span class="string">"""继续处理post未完成的步骤</span></div><div class="line">        """</div><div class="line"></div><div class="line">        ...</div><div class="line">        some biz code here</div><div class="line">        ...</div><div class="line"></div><div class="line">        self.finish(<span class="string">'ok'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">notify</span><span class="params">(self, retry_t)</span>:</span></div><div class="line">        <span class="string">"""循环访问异步接口</span></div><div class="line">        retry_t 标志访问的次数</div><div class="line">        """</div><div class="line"></div><div class="line">        <span class="keyword">if</span> retry_t &lt;= <span class="number">0</span>:</div><div class="line">            <span class="comment">#超过了重试的最大次数，抛出异常</span></div><div class="line">            <span class="keyword">raise</span> ServiceError</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">fetch_cb</span><span class="params">(data)</span>:</span></div><div class="line">            <span class="string">"""异步http client回调，如果code不为200，继续调用notify</span></div><div class="line">            """</div><div class="line"></div><div class="line">            <span class="keyword">if</span> data.code == <span class="number">200</span>:</div><div class="line">                self.post1(data.body)</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                self.notify(retry_t<span class="number">-1</span>)</div><div class="line"></div><div class="line">        <span class="comment"># 异步的http client</span></div><div class="line">        http_client.fetch(request, fetch_cb)</div></pre></td></tr></table></figure>
</li>
<li><p>异步调用列表<br>另一个典型的场景是有一系列的异步调用，希望所有的调用都返回结构之后在开始后面的代码流程<br>用tornado的gen逻辑来实现就是下面的写法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> tornado.web</div><div class="line"><span class="keyword">import</span> tornado.gen</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></div><div class="line"></div><div class="line"><span class="meta">    @tornado.web.asynchronous</span></div><div class="line"><span class="meta">    @tornado.gen.engine</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""Tornado handler post 入口</span></div><div class="line">        """</div><div class="line"></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            ...</div><div class="line">            some biz code here</div><div class="line">            ...</div><div class="line"></div><div class="line">            response = <span class="keyword">yield</span> tornado.gen.Task[(http_client.fetch, request1),</div><div class="line">                                            http_client.fetch, request2),</div><div class="line">                                            http_client.fetch, request3),</div><div class="line">                                            http_client.fetch, request4)]</div><div class="line"></div><div class="line">            ...</div><div class="line">            some biz code here</div><div class="line">            ...</div><div class="line"></div><div class="line">            self.finish(ok)</div><div class="line"></div><div class="line">        <span class="keyword">except</span>:</div><div class="line">            ....</div></pre></td></tr></table></figure>
<p>改为普通的异步回调callback写法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> tornado.web</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestHandler</span><span class="params">(tornado.web.RequestHandler)</span>:</span></div><div class="line"></div><div class="line"><span class="meta">    @tornado.web.asynchronous</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""Tornado handler post 入口</span></div><div class="line">        """</div><div class="line"></div><div class="line">        ...</div><div class="line">        some biz code here</div><div class="line">        ...</div><div class="line"></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            notify = notify_list(<span class="number">4</span>, self.post1)</div><div class="line"></div><div class="line">            <span class="comment"># 异步的http client</span></div><div class="line">            http_client.fetch(request1, notify.notify_list_cb)</div><div class="line">            http_client.fetch(request2, notify.notify_list_cb)</div><div class="line">            http_client.fetch(request3, notify.notify_list_cb)</div><div class="line">            http_client.fetch(request4, notify.notify_list_cb)</div><div class="line"></div><div class="line">        <span class="keyword">except</span>:</div><div class="line">            ...</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post1</span><span class="params">(self, data)</span>:</span></div><div class="line">        <span class="string">"""继续处理post未完成的步骤</span></div><div class="line">        """</div><div class="line"></div><div class="line">        ...</div><div class="line">        some biz code here</div><div class="line">        ...</div><div class="line"></div><div class="line">        self.finish(<span class="string">'ok'</span>)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotifyList</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">"""用于处理回调列表的类</span></div><div class="line">    """</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, caller_n, final_cb)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line">            caller_n 回调列表的长度</div><div class="line">            final_cb 全部回调完成后的最终出口回调</div><div class="line">        """</div><div class="line"></div><div class="line">        self._caller_n = caller_n</div><div class="line">        self._data_list = []</div><div class="line">        self._final_cb = final_cb</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">notify_list_cb</span><span class="params">(self, data)</span>:</span></div><div class="line"></div><div class="line">        self._caller_n -=<span class="number">1</span></div><div class="line">        <span class="keyword">if</span> self._caller_n == <span class="number">0</span>:</div><div class="line">            self._final_cb(self._data_list)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            self._data_list.append(data)</div></pre></td></tr></table></figure>
</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://lightthewoods.me/2013/12/18/OpenStack基础组件kombu杂谈/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ethan Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xpwqp.com1.z0.glb.clouddn.com/avatar_01.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="林中小灯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2013/12/18/OpenStack基础组件kombu杂谈/" itemprop="url">
                  OpenStack基础组件kombu杂谈
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2013-12-18T09:36:53+08:00">
                2013-12-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>&emsp;&emsp;作为一个典型的分布式系统，OpenStack的各模块之间也需要进行大量的消息传递。OpenStack采用的是AMQP的消息队列方案。<br>&emsp;&emsp;AMQP是一个广泛使用的消息队列的规范。服务端常采用的是RabbitMQ（在AMQP的规范中，消息队列的服务端被成为broker），现在已收归vmware麾下，使用erlang实现。OpenStack除了支持RabbitMQ之外，还支持apache上开源的Qpid。Qpid有C++和java两种broker的实现。</p>
<blockquote>
<p>kombu是AMQP协议client端的一个python实现。另有比较常用的有如pika，py-amqplib等。<br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2013/12/18/OpenStack基础组件kombu杂谈/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://lightthewoods.me/2013/12/03/Tornado生产骨架——mownfish介绍/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ethan Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xpwqp.com1.z0.glb.clouddn.com/avatar_01.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="林中小灯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2013/12/03/Tornado生产骨架——mownfish介绍/" itemprop="url">
                  Tornado生产骨架——mownfish介绍
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2013-12-03T15:39:03+08:00">
                2013-12-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <blockquote>
<p>曾经给大家介绍了许多优秀的开源项目，今天为大家介绍我的在githup上开源的一个tornado生产骨架——<a href="https://github.com/Ethan-Zhang/mownfish">mownfish</a>，欢迎大家拍砖~</p>
</blockquote>
<p>　　Tornado是用python写的一个基于linux epoll的异步非阻塞IO实时框架，最早产生于FriendFeed，09年被Facebook收购并开源。这个框架被广泛的应用于互联网实时信息处理领域，如long polling、websocket等。将晦涩难以理解的linux epoll的相关操作封装在了IOLoop，IOStream等模块中，方便开发者更快捷的使用linux epoll的异步非阻塞IO。其代码结构和运行效率都像她的名字一样，tornado——龙卷风，轻量、迅捷、快速。然而如此强大的框架也有许多不足之处，因为其依赖异步非阻塞的IO工作方式，如果代码内有IO操作阻塞了进程，将会使整个服务不能响应。所以就需要我们使用的相关涉及网络IO的客户端如MySQL-client等也是支持异步的，这时非常复杂的，因为大部分主流的客户端库都是同步的IO方式。第二，其代码和文档符合Facebook开源项目的一贯风格，基本无文档，注释也很少，需要开发者查看具体的框架代码以理解其实现，不然会有很多的谬用。第三，tornado是以python模块的形式发布了代码，并非像姜哥或者其他的php、rails风格的框架等，自己的应用代码就是直接写在框架内部，也就是说框架已经规范了应用的代码结构。tornado需要自己来实现应用的代码结构，不管是tornado的新手还是老手，在新建一个项目的时候都要或多或少的重复写一些项目的初始化代码，完成代码的骨架。<br>　　mownfish的产生就是为了解决代码骨架的问题。mownfish，其名字来源于我工作过的一家公司的logo，一个脸长得非常怪的鱼，我称之为怪脸鱼。mownfish是一个基于tornado的生产骨架，目的是帮助开发者快速、高效、规范的生成一个应用的代码骨架，并增加少量的如log，脚本等功能。<br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2013/12/03/Tornado生产骨架——mownfish介绍/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://lightthewoods.me/2013/11/18/Python多进程log日志切分错误的解决方案/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ethan Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="http://7xpwqp.com1.z0.glb.clouddn.com/avatar_01.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="林中小灯">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2013/11/18/Python多进程log日志切分错误的解决方案/" itemprop="url">
                  Python多进程log日志切分错误的解决方案
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2013-11-18T16:34:42+08:00">
                2013-11-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>　　在生产环境中，log一般按照时间进行切分，如在23:59:59切分一天的日志，以便进行分析。在python中常用内建的logging模块实现。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">logger = logging.getLogger()</div><div class="line">logger.setLevel(logging.DEBUG)   </div><div class="line">log_file = <span class="string">'tornadolog.log'</span></div><div class="line">timelog = timelog = logging.handlers.TimedRotatingFileHandler(log_file,</div><div class="line">                                                            <span class="string">'midnight'</span>,</div><div class="line">                                                            <span class="number">1</span>, <span class="number">0</span>)</div><div class="line">logger.addHandler(timelog)</div><div class="line"></div><div class="line">logger.info(<span class="string">'Hello log'</span>)</div></pre></td></tr></table></figure></p>
<p>　　但是，像tornado这种推荐进行多进程部署的框架，在类似的日志切分上会发生错误，原因是单个的日志文件作为进程间的共享资源，当其中一个进程进行日志切分的时候，实际上是将原来的日志文件改名，然后新建一个日志文件，文件操作描述符fd发生了改变，其它的进程不知道这个操作，再次写入日志的时候因为找不到新的文件描述符发生异常。<br>解决方法也很简单，我们可以是每个tornado进程都有一个自己的日志文件，通过进程的task_id进行区分，避免进程间共享资源的操作。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># Copyright 2012 Ethan Zhang&lt;http://github.com/Ethan-Zhang&gt;</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># Licensed under the Apache License, Version 2.0 (the "License"); you may</span></div><div class="line"><span class="comment"># not use this file except in compliance with the License. You may obtain</span></div><div class="line"><span class="comment"># a copy of the License at</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment">#     http://www.apache.org/licenses/LICENSE-2.0</span></div><div class="line"><span class="comment">#</span></div><div class="line"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></div><div class="line"><span class="comment"># distributed under the License is distributed on an "AS IS" BASIS, WITHOUT</span></div><div class="line"><span class="comment"># WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the                                                    </span></div><div class="line"><span class="comment"># License for the specific language governing permissions and limitations</span></div><div class="line"><span class="comment"># under the License.</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">import</span> signal                                                                                                                 </div><div class="line"><span class="keyword">import</span> os                                                                                                                     </div><div class="line"><span class="keyword">import</span> logging                                                                                                                </div><div class="line"><span class="keyword">import</span> logging.handlers                                                                                                       </div><div class="line"></div><div class="line"><span class="keyword">import</span> tornado</div><div class="line"><span class="keyword">import</span> tornado.netutil                                                                                                        </div><div class="line"><span class="keyword">import</span> tornado.process                                                                                                        </div><div class="line"><span class="keyword">from</span> tornado.ioloop <span class="keyword">import</span> IOLoop                                                                                             </div><div class="line"><span class="keyword">from</span> tornado.httpserver <span class="keyword">import</span> HTTPServer                                                                                     </div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">handle_request</span><span class="params">(request)</span>:</span></div><div class="line">    message = <span class="string">"You requested %s\n"</span> % request.uri                                                                              </div><div class="line">    request.write(<span class="string">"HTTP/1.1 200 OK\r\nContent-Length: %d\r\n\r\n%s"</span> % (                                                       </div><div class="line">                               len(message), message))</div><div class="line">    request.finish()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">kill_server</span><span class="params">(sig, frame)</span>:</span></div><div class="line"></div><div class="line">    IOLoop.instance().stop()</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line"></div><div class="line">    signal.signal(signal.SIGPIPE, signal.SIG_IGN);</div><div class="line">    signal.signal(signal.SIGINT, kill_server)</div><div class="line">    signal.signal(signal.SIGQUIT, kill_server)</div><div class="line">    signal.signal(signal.SIGTERM, kill_server)</div><div class="line">    signal.signal(signal.SIGHUP, kill_server)</div><div class="line"></div><div class="line">    sockets = tornado.netutil.bind_sockets(<span class="number">9204</span>)</div><div class="line">    task_id = tornado.process.fork_processes(<span class="number">2</span>)</div><div class="line">    <span class="comment">#task_id为fork_processes返回的子进程编号</span></div><div class="line"></div><div class="line">    logger = logging.getLogger()</div><div class="line">    logger.setLevel(logging.DEBUG)</div><div class="line">    log_file = <span class="string">'tornadolog.log.%d'</span> % (task_id)</div><div class="line">    <span class="comment">#以子进程编号命名自己的log文件名</span></div><div class="line">    timelog = timelog = logging.handlers.TimedRotatingFileHandler(log_file,</div><div class="line">                                                                <span class="string">'midnight'</span>,</div><div class="line">                                                                <span class="number">1</span>, <span class="number">0</span>)</div><div class="line">    logger.addHandler(timelog)</div><div class="line"></div><div class="line">    server = HTTPServer(handle_request)</div><div class="line">    server.add_sockets(sockets)</div><div class="line"></div><div class="line">    logger.info(<span class="string">'Server Starting...'</span>)</div><div class="line"></div><div class="line">    IOLoop.instance().start()</div><div class="line">    server.stop()</div><div class="line">    IOLoop.instance().stop()</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main()</div></pre></td></tr></table></figure></p>
<hr>
<p><strong>2013-11-25新增</strong></p>
<hr>
<p>　　其实我们分析Python的内建库logging的源码就能发现问题<br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2013/11/18/Python多进程log日志切分错误的解决方案/#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://7xpwqp.com1.z0.glb.clouddn.com/avatar_01.jpg"
               alt="Ethan Zhang" />
          <p class="site-author-name" itemprop="name">Ethan Zhang</p>
           
              <p class="site-description motion-element" itemprop="description">个人技术博客分享</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">25</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">29</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ethan-zhang" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/1920663143" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  微博
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2012 - 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ethan Zhang</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>


        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  




	





  
    
    <script>
      var cloudTieConfig = {
        url: document.location.href, 
        sourceId: "",
        productKey: "abb18f73d61b4319b07352052b36d826",
        target: "cloud-tie-wrapper"
      };
    </script>
    <script src="https://img1.ws.126.net/f2e/tie/yun/sdk/loader.js"></script>
  










  





  

  

  

  

</body>
</html>
